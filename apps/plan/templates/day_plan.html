{% extends 'base.html' %}
{% block content%}



<style>
      .trip-planner {
  padding: 1rem;
}

.trip-header {
  margin-bottom: 1rem;
}

.trip-title {
  font-size: 1.5rem;
  font-weight: bold;
}

.edit-option {
  font-size: 0.875rem;
  font-weight: normal;
}

.trip-date, .trip-type {
  color: #666;
}

.main-actions, .secondary-actions, .day-actions {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.btn {
  padding: 0.5rem 1rem;
  border-radius: 0.25rem;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn-primary {
  background-color: #3b82f6;
  color: white;
  border: none;
}

.btn-primary:hover {
  background-color: #2563eb;
}

.btn-secondary {
  background-color: white;
  color: #333;
  border: 1px solid #d1d5db;
}

.btn-secondary:hover {
  background-color: #f3f4f6;
}

.day-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.day-title {
  font-size: 1.125rem;
  font-weight: bold;
}

.day-date {
  color: #666;
}

.modal{
    position:absolute;
    display:none;
    
    justify-content: center;
    top:0;
    left:0;

    width:100%;
    height:100%;

    background-color: rgba(0,0,0,0.4);
}
.modal_body{
    position:absolute;
    top:50%;  


    width:400px;   
    height:600px; 

    padding:40px;  

    text-align: center;

    background-color: rgb(255,255,255); 
    border-radius:10px;  
    box-shadow:0 2px 3px 0 rgba(34,36,38,0.15); 

    transform:translateY(-50%);
     
}
#modalCloseButton{
    border: none;
    background-color: white;
    position:absolute;
    right: 15px;
}
.spot_btn{
    background-color: gainsboro; 
    border-radius: 20px;
    font-weight: 900;
    height: 40px;
}
</style>
<div class="container">
<div class="trip-planner">
    <div class="trip-header">
      <h1 class="trip-title">{{new_trip.city}} 여행<span class="edit-option">편집</span></h1>
      <p class="trip-date">{{new_trip.start_date|date:"Y.m.d"}} ~ {{new_trip.end_date|date:"Y.m.d"}}</p>
      <p class="trip-type">{{new_trip.who}} | {%for i in style%}{{i}}{%endfor%}</p>
    </div>
    <div class="main-actions">
      <button class="btn btn-primary">+ 일행과 함께 일정짜기</button>
      <button class="btn btn-primary">% 셀프 패키지</button>
    </div>
    <div class="secondary-actions">
      <button class="btn btn-secondary">+ 항공편</button>
      <button class="btn btn-secondary">+ 숙소</button>
      <button class="btn btn-secondary">체크리스트</button>
      <button class="btn btn-secondary">가계부</button>
    </div>

    <div id="map" style="width:500px;height:400px;"></div>
    <div id="mapx" style="display: none;">
      {% for i in tour_spots %}
        {{i.id}}:{{ i.map_x }},
      {% endfor %}
    </div>
    <div id="mapy" style="display: none;">
      {% for i in tour_spots %}
        {{i.id}}:{{ i.map_y }},
      {% endfor %}
    </div>
    <div id="name" style="display: none;">
      {% for i in tour_spots %}
        {{i.id}}:{{ i.title }},
      {% endfor %}
    </div>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ KAKAO_API_KEY }}"></script>
    
    {% for day,origin in days %}
    <div class="day-planner" data-date="{{origin}}">
      <div class="day-header">
        <h2 class="day-title">day {{ forloop.counter}}</h2>
        <p class="day-date">{{day}}</p>
      </div>
      
      <div id="spot-container">
        {% for i in plan %}
          {% if i.day|date:'Y-m-d' == origin %}
          <div class="d-flex align-items-center">
          <div style="display: flex; width: 36px; height: 36px; background-color: slateblue; border: 1px; border-radius: 50%; color: white; align-items: center; justify-content: center; margin-right: 30px;">{{ forloop.counter}}</div>
          <div id="{{i.spot.id}}" class="mb-2" data-xy="{{i.spot.map_x}},{{i.spot.map_y}},{{i.spot.title}}" style="border: 1px #E2E2E2 solid; width: 460px; height: 80px; display: flex; align-items: center;">
            <div id="add_spot" class="mt-1">
                <div style="font-weight: bold; font-size: 20px;">{{i.spot.title}}</div>
                <p>관광명소·{{i.spot.address}}</p> 
            </div>
            <button class="del_btn ms-auto">x</button>
          </div>
          </div>
          {% endif %}
        {% endfor %}
        
      </div>
      <div class="day-actions">
        <button class="btn btn-secondary btn-open-modal" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="addDay('{{origin}}')">장소 추가</button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#memo" >메모 추가</button>
      </div>
    </div>
    {% endfor %}
  </div>

<!-- Modal -->
<div class="modal fade" id="memo" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea name="" id="" style="width: 100%; height: 400px;" placeholder="잊기 쉬운 정보들을 메모해보세요."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">추천 관광지</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="removeDay()"></button>
      </div>
      
        
        <div class="modal-body">
          <input type="hidden" name="trip" value="{{new_trip.id}}">
          <div id="check-day">

          </div>
          <div id="check-spot" class="d-flex">
            
          </div>
          <p>
            {% for spot in tour_spots %}
            <div class="d-flex" id="modal-{{spot.id}}">
              <img src="{{spot.image_url}}" alt="" style="height: 50px; width: 50px;">
              {{spot.title}}
              <button type="button" class="btn ms-auto spot_btn" data-content-id="{{spot.content_id}}" onclick="addSpot('{{spot.image_url}}', '{{spot.title}}', '{{spot.content_id}}')">선택</button>
            </div>
            {% endfor %}
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="removeDay()">Close</button>
          <button type="submit" class="btn btn-primary" data-bs-dismiss="modal" onclick="addPlan()">Save changes</button>
        </div>
  
    </div>
  </div>
</div>

  <!-- <div class="modal hidden ">
    <div class="modal_body">
        <div class="d-flex" style="justify-content: center;">
            <div>
            <h2>추천 장소</h2>
            </div>
            <button id="modalCloseButton">x</button>
        </div>
         
        <p>
          {% for spot in tour_spots %}
          <div class="d-flex">
            <img src="{{spot.image_url}}" alt="" style="height: 50px; width: 50px;">
            {{spot.title}}
          </div>
          {% endfor %}
        </p>
    </div>
  </div> -->
</div>

<script defer>
    const modal = document.querySelector('.modal');
    const btnOpenModal=document.querySelector('.btn-open-modal');
    const modalCloseButton = document.getElementById('modalCloseButton');
    btnOpenModal.addEventListener("click", ()=>{
        modal.style.display="flex";
    });
    modalCloseButton.addEventListener('click', () => {
        modal.style.display='none';
});
function addSpot(imageUrl, title, contentId) {
  const checkSpot = document.getElementById('check-spot');
  if (document.querySelector(`#check-spot input[value="${contentId}"]`)) {
    alert('이미 선택된 여행지입니다')
  } else{

    const spotElement = document.createElement('div');
    spotElement.classList.add('d-flex', 'align-items-center', 'mb-2');
    spotElement.innerHTML = `
      <img src="${imageUrl}" alt="" style="height: 30px; width: 30px;">
      
      <button type="button" class="btn-close" style='width:10px; height:10px' onclick="removeSpot(this)"></button>
      <input type="hidden" name="add_spot" value="${contentId}">
      
    `;
    spotElement.setAttribute('data-content-id', contentId);
    checkSpot.appendChild(spotElement);
  }
}

function removeSpot(button) {
  const spotElement = button.parentElement;
  spotElement.remove();
}

function addDay(day){
  const checkDay = document.getElementById('check-day');
  checkDay.innerHTML = '';
  const dayElement = document.createElement('div');
  dayElement.id='day';
  dayElement.innerHTML=`
  <input type="hidden" name="add_day" value="${day}">
  `
  checkDay.appendChild(dayElement);
  console.log(1)
  addSpotList=document.querySelectorAll('#spot-container .mb-2')
  addSpotList.forEach(spot => {
    console.log(spot.id)
    aa = document.getElementById(`modal-${spot.id}`);
    console.log(aa)
    if(aa){
      aa.remove();
    }
  })  
  
}

function removeDay() {
  const dayElement = document.getElementById('day');
  dayElement.remove();
  const check_spot_remove = document.getElementById('check-spot')
  check_spot_remove.innerHTML=''
  console.log('close')
}

function addPlan(){
  console.log(12);
  const day = document.querySelector('input[name="add_day"]');
  
  const dayValue = day ? day.value : null;
  const spot = document.querySelectorAll('input[name="add_spot"]');
  
  const spotValues = Array.from(spot).map(spot => spot.value);
  const trip = '{{new_trip.id}}'
  const baseUrl ='{% url "plan:add_plan" %}?ajax=true&day='+dayValue + '&trip_id=' + trip +'&spot_content='+spotValues;
  
  fetch(baseUrl)
  .then(response => response.json())
  .then(data => {
    const dayContainer = document.querySelector(`.day-planner[data-date="${dayValue}"] #spot-container`);
    const spotsByDay = {};
    data.forEach(spot => {
      console.log(spot)
      // 최상위 div 생성
      const spotDiv = document.createElement('div');
      spotDiv.className = 'mb-2';
      spotDiv.style.cssText = 'border: 1px #E2E2E2 solid; width: 460px; height: 80px; display: flex; align-items: center;';
      spotDiv.id=spot.spot
      
      // 내부 div 생성
      const innerDiv = document.createElement('div');
      innerDiv.className = 'mt-1';
      
      // 제목 div 생성
      const titleDiv = document.createElement('div');
      titleDiv.style.fontWeight = 'bold';
      titleDiv.style.fontSize = '20px';
      titleDiv.textContent = spot.title;
      
      // 주소 p 생성
      const addressP = document.createElement('p');
      addressP.textContent = `관광명소·${spot.address}`;
      const del = document.createElement('button');
      del.textContent = 'x'
      del.classList.add('ms-auto','del_btn')
      // 요소들을 조립
      innerDiv.appendChild(titleDiv);
      innerDiv.appendChild(addressP);
      spotDiv.appendChild(innerDiv);
      spotDiv.appendChild(del);
      // 최종 구조를 컨테이너에 추가
      dayContainer.appendChild(spotDiv);
    })
     // 모든 데이터 처리가 완료된 후 페이지 새로고침
     window.location.reload();
  })
  .catch(error => console.error('Fetch 오류:', error));
}


</script>
<script>
    function createMarkerImage(number) {
      var canvas = document.createElement('canvas');
      var context = canvas.getContext('2d');
      canvas.width = 36;
      canvas.height = 36;

      // 원 그리기
      context.beginPath();
      context.arc(18, 18, 18, 0, 2 * Math.PI);
      context.fillStyle = 'slateblue';
      context.fill();

      // 텍스트 추가
      context.font = 'bold 14px Arial';
      context.fillStyle = 'white';
      context.textAlign = 'center';
      context.textBaseline = 'middle';
      context.fillText(number, 18, 18);

      return canvas.toDataURL();
    }
      var container = document.getElementById('map');
      var options = {
        center: new kakao.maps.LatLng(37.6613809173, 127.5239353212),
        level: 3
      };

      var map_xy = new Array();
      var list_name = new Array();
      
      document.querySelectorAll('.mb-2').forEach(xy => {
        console.log(xy.dataset['xy'].split(','))
        map_xy.push(xy.dataset['xy'].split(','))
      })
      console.log(map_xy)
      
      var map = new kakao.maps.Map(container, options);
      
  
      var xy = new Array();

      for(var idx=0; idx<map_xy.length; idx++){
        var x = map_xy[idx][0];
        var y = map_xy[idx][1];
        xy.push(new kakao.maps.LatLng(y,x));
      }

      for(var idx=0; idx<xy.length; idx++){
        var markerImage = new kakao.maps.MarkerImage(
        createMarkerImage(idx + 1),
        new kakao.maps.Size(36, 36),
        {offset: new kakao.maps.Point(18, 18)}
    );
        var marker = new kakao.maps.Marker({
          map: map,
          position: xy[idx],
          title: map_xy[idx][2],
          image: markerImage,
        })
        
      }
      const REST_API_KEY = 'REST_API_KEY';
      const url = 'https://apis-navi.kakaomobility.com/v1/directions';


    // 선을 구성하는 좌표 배열입니다. 이 좌표들을 이어서 선을 표시합니다
      var linePath = [
          new daum.maps.LatLng(37.6613809173,127.5239353212 ),
          new daum.maps.LatLng(37.8594737524, 127.480533482) 
      ];

      // 지도에 표시할 선을 생성합니다
      var polyline = new daum.maps.Polyline({
          path: linePath, // 선을 구성하는 좌표배열 입니다
          strokeWeight: 5, // 선의 두께 입니다
          strokeColor: 'black', // 선의 색깔입니다
          strokeOpacity: 0.7, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
          strokeStyle: 'dashed' // 선의 스타일입니다
      });
      var lengthInMeters = polyline.getLength();
      var lengthInKm = (lengthInMeters / 1000).toFixed(2);  // 킬로미터 단위로 변환하고 소수점 둘째 자리까지 표시

      console.log("길이: " + lengthInMeters.toFixed(2) + " 미터");
      console.log("길이: " + lengthInKm + " 킬로미터");

      // 거리 정보를 표시할 div 요소 생성
      var distanceDiv = document.createElement('div');
      distanceDiv.className = 'distance-info';
      distanceDiv.innerHTML = lengthInKm + ' km ';

      // 스타일 설정
      distanceDiv.style.position = 'absolute';
      distanceDiv.style.bottom = '78px';
      distanceDiv.style.left = '110px';
      distanceDiv.style.backgroundColor = 'white';
      distanceDiv.style.padding = '5px';
      distanceDiv.style.border = '1px solid #E2E2E2';
      distanceDiv.style.borderRadius = '5px';
      distanceDiv.style.zIndex = '1000';

      // 지도 컨테이너에 거리 정보 div 추가
      var mapContainer = document.getElementById('93'); // 여기서 'map'은 지도를 표시하는 div의 id입니다
      mapContainer.appendChild(distanceDiv);

      polyline.setMap(map);
      marker.setMap(map);
</script>
{% endblock %}
